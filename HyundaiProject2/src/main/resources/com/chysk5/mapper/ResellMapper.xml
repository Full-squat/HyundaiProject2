<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chysk5.mapper.ResellMapper">

   <select id="getMyResellProduct"
      resultType="com.chysk5.domain.ResellProductDTO">
      SELECT r.pro_name, r.pro_opt_size, r.pro_price, r.pro_id, r.pro_loc
      FROM(
      SELECT pro_name, pro_opt_size, pro_price, pro_id, pro_loc
      FROM product p
      INNER
      JOIN product_option po
      ON p.pro_id = po.product_pro_id
      and po.pro_opt_id = #{pro_opt_id}
      INNER JOIN pro_image pi
      ON pi.product_pro_id = p.pro_id
      AND pi.pro_loc LIKE ('%medium%')
      )r
   </select>

   <select id="getPriceList" resultType="com.chysk5.domain.ResellPriceDTO">
   <![CDATA[
      SELECT resell.pro_opt_size, resell.re_price
      FROM
      (SELECT p.pro_opt_size, r.re_price
      FROM r_product r
      INNER JOIN product_option p
      ON r.product_option_pro_opt_id = p.pro_opt_id
      WHERE r.product_option_pro_opt_id = #{pro_opt_id}
      ORDER BY r.re_price ASC) resell
      WHERE ROWNUM <= 5
      ]]>
   </select>

   <insert id="register">
      INSERT INTO r_product (re_id, re_price, re_regdate, re_update, re_available,
      member_mem_id, product_option_pro_opt_id)
      VALUES (REG_RESELL_SEQ.nextval,
      #{re_price}, sysdate, sysdate, #{re_available}, #{member_mem_id},
      #{product_option_pro_opt_id})
   </insert>

   
   <select id="getMyRank" resultType="int">
   <![CDATA[
      SELECT R.RANK
      FROM(
      SELECT re_id, RANK() OVER (ORDER BY re_price ASC) AS RANK 
      FROM r_product
      WHERE r_product.product_option_pro_opt_id = #{pro_opt_id}
      AND re_price < #{re_price}
      ORDER BY RANK DESC) R
      WHERE ROWNUM = 1
      ]]>
   </select>
   
   <select id="existData" resultType="int">
   <![CDATA[
      SELECT count(*)
      FROM r_product
      WHERE r_product.product_option_pro_opt_id = #{pro_opt_id}
      AND re_price < #{re_price}
      ]]>    
   </select>
   
   
   
   <update id="updateRegStatus">
	   UPDATE order_detail SET ORDER_REG_RESELL_CHECK = '1'
	   WHERE order_total_order_no = #{order_no}
	   AND product_option_pro_opt_id = #{pro_opt_id}
   </update>
	
	
	<!--함세강 작성  -->
	<select id="getResellProductList" resultType="com.chysk5.domain.ResellProductListDTO">
		select * from resell_Prolist_view
	
	</select>
	
	<select id="getResellProductListImg" resultType="com.chysk5.domain.ResellProductImgDTO">
		select * from pro_image where product_pro_id = #{proId}
	</select>
	
	<select id="getResellProductDetail" resultType="com.chysk5.domain.ResellProductDetailInfoDTO">
		select pro_id, pro_name,pro_category, pro_price
		from product
		where pro_id = #{proId}
	</select>

	<select id="getResellProductDetailImgs" resultType="com.chysk5.domain.ResellProductImgDTO">
		select *
		from pro_image
		where product_pro_id = #{proId}
	</select>
	
	<select id="getResellProductDetailSizes" resultType="com.chysk5.domain.ResellProductSizeDTO">
		select pro_opt_size
		from resell_pro_detail_size
		where pro_id = #{proId}
		order by pro_opt_size desc
	</select>
	
	<select id="getResellProductSearchOptId" resultType="com.chysk5.domain.ResellProductSearchIdDTO">
		
		select pro_opt_id
		from product p right join product_option po 
			 on p.pro_id = po.product_pro_id
		where pro_name = #{proName} and pro_opt_size = #{sizeVal}

	</select>
	
	<select id="getResellProductDetailLowPrice" resultType="com.chysk5.domain.ResellProductDetailPriceDTO">
		select re_price re_low_price
		from(
		    select re_price, re_regdate, re_update 
		    from r_product 
		    where re_available = '0'and product_option_pro_opt_id=#{proOptId}
		    order by re_price
		)
		where rownum=1
	
	</select>
	
	<select id="getResellProductDetailDatePrice" resultType="com.chysk5.domain.ResellProductDetailPriceDateDTO">
		<![CDATA[ 
			select stv.price_date re_selldate, nvl(t.avg_price,0) avg_price
			from sysdate_test_view stv left join (
			    select round(avg(re_price),-3) avg_price, re_selldate
			    from r_product 
			    where re_available = '1'and product_option_pro_opt_id= #{proOptId}
			    group by re_selldate
			)t on stv.price_date = trunc(t.re_selldate)
			order by stv.price_date
		]]>
	</select>
	

</mapper>
  