<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.chysk5.mapper.MyPageMapper">
  
  <resultMap type="com.chysk5.domain.MyResellProductDTO" id="myResellMap">
  	<id property="pro_opt_id" column="product_option_pro_opt_id" />
  	<result property="re_regdate" column="re_regdate" />
  	<result property="re_id" column="re_id" />
  	<result property="pro_name" column="pro_name" />
  	<result property="pro_loc" column="pro_loc" />
  	<result property="pro_opt_size" column="pro_opt_size" />
  	<result property="my_price" column="my_price" />
  	<collection property="priceRank" resultMap="priceRankMap">
  	</collection>
 </resultMap>
  
  <resultMap type="com.chysk5.domain.ResellPriceDTO" id="priceRankMap">
  	<result property="pro_opt_size" column="pro_opt_size" />
  	<result property="re_price" column="re_price" />
  </resultMap>
  	
 	<select id="getMyResellList" resultMap="myResellMap">

	 SELECT A.product_option_pro_opt_id, 
	 		A.my_price, 
	 		A.re_regDate, 
	 		A.pro_opt_size, 
	 		A.pro_name, 
	 		A.pro_loc,
	 		A.re_id,
	 		B.re_price FROM
    (SELECT r.product_option_pro_opt_id, 
    		r.re_price as my_price, 
    		r.re_regdate, 
    		po.pro_opt_size, 
    		p.pro_name, 
    		pi.pro_loc,
    		r.re_id
    FROM r_product r
    INNER JOIN product_option po
	ON r.product_option_pro_opt_id = po.pro_opt_id
    INNER JOIN product p
	ON p.pro_id = po.product_pro_id
    INNER JOIN pro_image pi
	on pi.product_pro_id = p.pro_id
	AND pi.pro_loc like('%medium%')
    INNER JOIN member m
    ON m.mem_id = r.member_mem_id
    where m.mem_id = #{mem_id}) A
    INNER JOIN 
    (SELECT r.product_option_pro_opt_id, 
    		r.re_price
    FROM r_product r) B
    ON A.product_option_pro_opt_id = B.product_option_pro_opt_id
    order by re_price asc
	
	</select>
	
	<delete id="removeMyResellProduct">
	
	DELETE FROM r_product
	WHERE product_option_pro_opt_id = #{pro_opt_id}
	AND member_mem_id = #{mem_id}
		
	</delete>

	<update id="modifyPrice">
	
	UPDATE r_product set re_price = #{re_price}
    where re_id = #{re_id}
    
	</update>
	
	<select id="getBuyProduct" resultType="com.chysk5.domain.BuyProductDTO">
	
	SELECT ot.order_date, p.pro_price, p.pro_name, po.pro_opt_size, od.order_detail_amount, ot.order_no, pi.pro_loc
    FROM order_total ot
    INNER JOIN order_detail od
    ON ot.order_no = od.order_total_order_no
    AND ot.member_mem_id = #{mem_id}
    INNER JOIN product_option po
    ON po.pro_opt_id = od.product_option_pro_opt_id
    INNER JOIN product p
    ON p.pro_id = po.product_pro_id
    INNER JOIN pro_image pi
    ON pi.product_pro_id = p.pro_id
    AND pi.pro_loc LIKE('%medium%')
	WHERE ot.order_resell_check = '1'
	 
	</select>
	
	<select id="getMySoldOutList" resultType="com.chysk5.domain.SoldOutProductDTO">
	
	 SELECT r.product_option_pro_opt_id, 
    	r.re_price, 
    	r.re_selldate, 
    	po.pro_opt_size, 
    	p.pro_name, 
    		pi.pro_loc
    FROM r_product r
    INNER JOIN product_option po
	ON r.product_option_pro_opt_id = po.pro_opt_id
    INNER JOIN product p
	ON p.pro_id = po.product_pro_id
    INNER JOIN pro_image pi
	on pi.product_pro_id = p.pro_id
	AND pi.pro_loc like('%medium%')
    INNER JOIN member m
    ON m.mem_id = r.member_mem_id
    WHERE m.mem_id = #{mem_id}
    AND re_available = '1'
	
	</select>
	
	
  

	<!-- 총 구매 금액 -->
	<select id="totalOrderPrice" resultType="int">
		SELECT NVL(SUM(pro_price*order_detail_amount), 0)
		FROM 
		    (SELECT pro_id, pro_opt_id, pro_price
		    FROM product p, product_option po
		    WHERE p.pro_id = po.product_pro_id) p, 
		    (SELECT MEMBER_MEM_ID, PRODUCT_OPTION_PRO_OPT_ID AS opt_id, ORDER_TOTAL_ORDER_NO, order_detail_amount
		    FROM order_total ot, order_detail od
		    WHERE ot.order_no = od.order_total_order_no
		    AND MEMBER_MEM_ID = #{mem_id}) m
		WHERE p.pro_opt_id = m.opt_id
	</select>
	
	<!-- 주문 내역 조회 -->
	<resultMap type="com.chysk5.domain.MyOrderDTO" id="myOrderMap">
		<id property="mem_id" column="mem_id"/>
		<result property="order_no" column="order_no"/>
		<result property="order_date" column="order_date"/>
		<result property="order_total_price" column="order_total_price"/>		
	</resultMap>
	
  </mapper>